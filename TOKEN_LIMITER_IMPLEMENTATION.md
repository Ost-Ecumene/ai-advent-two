# Реализация механизма обрезки сообщений по токенам

## Обзор

Реализован механизм автоматической обрезки сообщений пользователя, если они превышают лимит в 2000 токенов, с уведомлением пользователя о том, что сообщение было обрезано.

## Реализованные компоненты

### 1. TokenCounter.kt
**Путь:** `feature/chat/src/main/java/com/povush/chat/util/TokenCounter.kt`

Утилита для подсчета токенов в тексте:
- **countTokens()** - подсчитывает приблизительное количество токенов
- **truncateToTokens()** - обрезает текст до указанного количества токенов
- **truncateToLimit()** - обрезает текст до 2000 токенов

**Алгоритм подсчета токенов:**
- Русский текст: ~2.5 символа на токен
- Английский текст: ~4 символа на токен
- Смешанный текст: усредненный расчет

### 2. MessageTruncator.kt
**Путь:** `feature/chat/src/main/java/com/povush/chat/util/MessageTruncator.kt`

Утилита для обработки сообщений пользователя:
- **processUserMessage()** - основная функция обработки сообщений
- **shouldTruncate()** - проверка необходимости обрезки
- **getTokenCount()** - получение количества токенов

**Особенности:**
- Лимит: 2000 токенов
- Автоматическое добавление уведомления об обрезке
- Сохранение исходного сообщения для подсчета токенов

### 3. Интеграция в ChatRepositoryImpl
**Путь:** `feature/chat/src/main/java/com/povush/chat/repository/impl/ChatRepositoryImpl.kt`

Изменения в методе `sendRequest()`:
- Обработка входящего сообщения через `MessageTruncator`
- Добавление уведомления в историю чата при обрезке
- Показ количества токенов в исходном сообщении
- Обновление логики для агентских команд

## Как это работает

1. **Пользователь отправляет сообщение** через UI
2. **ChatRepositoryImpl.sendRequest()** получает сообщение
3. **MessageTruncator.processUserMessage()** обрабатывает сообщение:
   - Подсчитывает токены через `TokenCounter`
   - Если токенов > 2000, обрезает сообщение
   - Добавляет уведомление об обрезке
4. **Обработанное сообщение** добавляется в историю чата
5. **Уведомление об обрезке** (если было) добавляется как отдельное сообщение

## Пример работы

**Исходное сообщение (3000+ токенов):**
```
Очень длинное сообщение пользователя...
```

**После обработки:**
```
Очень длинное сообщение пользователя... [обрезано до 2000 токенов]

⚠️ Ваше сообщение было обрезано из-за превышения лимита в 2000 токенов. Токенов в исходном сообщении: 3247
```

## Технические детали

### Точность подсчета токенов
- Используется приблизительный алгоритм
- Учитывает различия между русским и английским текстом
- Бинарный поиск для оптимальной обрезки

### Производительность
- Быстрый подсчет токенов без обращения к внешним API
- Эффективный алгоритм обрезки
- Минимальное влияние на производительность чата

### Совместимость
- Работает со всеми типами сообщений
- Поддерживает агентские команды (/агенты, /agents)
- Совместимо с существующей архитектурой

## Статус реализации

✅ **Завершено:**
- Создание утилит для подсчета токенов
- Реализация механизма обрезки
- Интеграция в существующий код
- Добавление уведомлений пользователю
- Тестирование сборки модуля

✅ **Протестировано:**
- Сборка модуля `feature:chat` успешна
- Нет ошибок линтера
- Код компилируется без предупреждений

## Использование

Механизм работает автоматически - никаких дополнительных действий от пользователя не требуется. При превышении лимита в 2000 токенов сообщение будет автоматически обрезано с уведомлением.
